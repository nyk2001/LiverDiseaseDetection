---
title: "Liver Disease Classification"
author: "Nabeel Khan"
date: "27-May-2020"
output:
  pdf_document: 
    keep_tex: true
    number_sections: yes
    toc: yes
    highlight: tango
    df_print: kable
  html_document:
    df_print: paged
    number_sections: yes
    toc: yes
---
\section{Introduction}
\label{sec:introduction}
This report is part of the ‘HarvardX: PH125.9x Data Science: Capstone’ course. In this report, we chose a dataset of our choice and apply various machine learning techniques to perform binary classification to diagnose liver disease. 

\subsection{Background}
\label{sec:background}
The liver plays an important role in keeping us healthy. The main job of liver is to filter the blood coming from the digestive tract, before passing it to the rest of the body. The liver also turns nutrients into chemicals our body needs, turns food into energy, and filters out poisons. So, malfunctioing of liver affects the whole body.

The classification techniques are used in various automatic medical diagnoses tools\cite{cad}.The problems with liver patients are not easily discovered in an early stage. An early diagnosis of liver problems will help in increasing the survival rate of patiets. We can detect the liver disease by analyzing the levels of enzymes in the blood \cite{ld,bendi}. A classification algorithm capable of automatically detecting the liver disease can assisst the doctors. 

\subsection{Aim of Project}
\label{sec:aim}
The patients with liver disease are on the rise because of excessive consumption of
alcohol, inhale of harmful gases, intake of contaminated food, pickles and drugs. The aim of this proect is to develop a bianry classifier, which can use blood enzymes information to diagnose liver disease. 

\section{Dataset and Evaluation Metrics}
\label{sec:dataset}
We use the Liver Patient Records, which are collected from North East of Andhra Pradesh, India. The data set contains:
\begin{enumerate}
\item 416 liver patient records and 167 non-liver patient records.
\end{enumerate} 

\subsection{Download Data}
\label{sec:dd}
The dataset is publically available online both at Kaggle and UCI repository.
We download data from the website. Then, we split data into a training and validation sets. 
\begin{itemize}
\item 10\% of the data is used for validation, and 90% is used for training.
\end{itemize}
```{r}
################################
#  Install packages (if not installed)
################################
# Note: this process could take a couple of minutes
repos_path<- "http://cran.us.r-project.org"
if(!require(tidyverse)) install.packages("tidyverse", repos =repos_path)
if(!require(caret)) install.packages("caret", repos = repos_path)
if(!require(data.table)) install.packages("data.table", repos =repos_path)
if(!require(lubridate)) install.packages("lubridate", repos = repos_path)
if(!require(dplyr)) install.packages("dplyr", repos = repos_path)
if(!require(sjmisc)) install.packages("dplyr", repos = repos_path)
if(!require(sjmisc)) install.packages("scales", repos = repos_path)

################################
# Load libraries
################################
library(lubridate)
library(tidyverse)
library(dplyr)
library(lubridate)
library(sjmisc)
library(scales)

```

```{r}
################################
# Downloading data
################################
# Indian Live Patient Records :
 # https://www.kaggle.com/uciml/indian-liver-patient-records/
 # https://archive.ics.uci.edu/ml/machine-learning-databases/00225/Indian Liver Patient Dataset (ILPD).csv

url <- "https://archive.ics.uci.edu/ml/machine-learning-databases/00225/Indian Liver Patient Dataset (ILPD).csv"
# Download csv
liverData <- read.csv(url)

# Rename columns of csv
colnames(liverData)<- c("Age","Gender","Total_Bilirubin","Direct_Bilirubin", "Alkaline_Phosphotase","Alamine_Aminotransferase","Aspartate_Aminotransferase",	"Total_Protiens","Albumin","Albumin_and_Globulin_Ratio","Dataset")

################################
# Creating training and validation sets
################################

# Validation set will be 10% of whole data
set.seed(1, sample.kind = "Rounding")
test_index <- createDataPartition(y = liverData$Dataset, times = 1, p = 0.1, list = FALSE)

training <- liverData[-test_index,]
validation <- liverData[test_index,]

 # Removing the objects from environment as no longer required
rm(liverData)

```
\subsection{Metrics}
\label{sec:metrics}
To evaluate the performance of classifiers, we will use following metrics:
\begin{enumerate}
\item \textbf{Accuracy}
It is the ratio of number of correct predictions to the total number of input samples.
\begin{equation}
Accuracy = \frac{True positives + True negatives} {Total Predictions}
\end{equation}

\item \textbf{Sensitivity}
It is also referred as true positive rate or recall. It is the proportion of true positives that are correctly identified.

\begin{equation}
Sensitivity = \frac{Number of true positives} {Number of true positives + Number of false negatives}
\end{equation}

\item \textbf{Precision}
It is defined as the proportion of the true positives against all the positive
results.

\begin{equation}
Precision = \frac{Number of true positives} {Number of true positives + Number of false positives}
\end{equation}

\item \textbf{Specificity}
It is the True negative rate. It is the proportion of true negatives that are
correctly identified.

\begin{equation}
Specificity = \frac{Number of true negatives} {Number of true negatives + Number of false positives}
\end{equation}

\item \textbf{F1 Score}
One metric that is preferred over overall accuracy is the average of specificity and sensitivity, referred to as balanced accuracy. Because specificity and sensitivity are rates, it is more appropriate to compute the harmonic average. In fact, the F1-score is widely used to compute harmonic average of precision and recall.

\begin{equation}
F1 Score = 2 * \frac{Precision - Recall} {Precision + Recall}
\end{equation}

\end{enumerate}

\section{Data Exploration}
\label{sec:exploration}
The dataset contains 11 variables namely, 'Age','Gender','Total_Bilirubin', or "Alkaline_Phosphotase". The 'Dataset' variable indicates if the liver has a disease or not. For instance, a value of 1 indicates a disease and 2 indicates no disease. 


All other variables except ``Age", ``Gender", and ``Dataset" represent the amount of enzymes in the blood. These variables will be used to train our machine learning models for making predictions or diagnosis. 

\small
```{r}
head(training)
```

The training dataset has 523 records and there are no null values (confirmed using summary). 
```{r}
sprintf("Rows of training dataset = %d", nrow(training))
print("=========================")
summary(training)
```
\subsubsection{Data Wrangling}
\label{sec:dw}
The variable ``Dataset" is our prediction and we will use it to analyse the performance of machine lerning models. To improve readability, we create a new column namely "Liver Disease", which will have two values: 
\begin{enumerate}
\item Malignant (M) indicating that the patienit has a liver disease.
\item Benign (B) indicating that the patient has no no liver disease.
\end{enumerate}


After creating a new column, wr delete the 'Dataset' variable. We apply these operations to both training and validation datasets.

```{r}
# Adding a new column, which will contain the disease information
training <- transform(training, Disease= ifelse(Dataset==1, "M","B"))
validation <- transform(validation, Disease= ifelse(Dataset==1, "M","B"))

# Deleting the column 'Dataset' as no longer required
training<-within(training, rm(Dataset))
validation<-within(validation, rm(Dataset))

# Displaying the first siz rows
head(training)
```

\section{Data Analysis}
\label{sec:dataanalysis}
In this section, we extract insights from all variables to get in depth understanding.

\subsection{Age}
The dataset consists of patients with varying ages, which makes this dataset robust and un-biased towards a specific age group. 

```{r}
# Extracting frequency of patient ages
age_stats <-as.data.frame(table(training$Age))
names(age_stats)<- c("Age","Count")
# Remvoing the factor
age_stats$Age<-as.numeric(levels(age_stats$Age))

# Plotting distribution of ages
age_stats %>% ggplot(aes(Age, Count)) +
  geom_point(color="cadetblue") +
  scale_x_continuous(breaks = round(seq(min(age_stats$Age), max(age_stats$Age), by = 6),1)) +
  ggtitle("Distribution of Patient Ages")

```
We analyse the age distributions with respect to the liver disease. The distributions again suggest a good spread of age group. 

```{r}
# Plotting distributions of ages versus liver diseases
training %>% 
  ggplot(aes(as.numeric(row.names(training)),Age, color=Disease)) +
  geom_point() +
  labs(y="Age", x = "Number of patients")+
  facet_wrap( ~ Disease) +
  ggtitle("Distribution of ages w.r.t liver disease")
```
\subsection{Gender}
The analysis indicates that 76% of the patient records belong to males. It would have been good to have more and less equal distribution of genders. Although, it may not make difference in the performance of models.  
```{r}
# Getting summary of genders
summary(training$Gender)
```
\subsection{Total_Bilirubin}
Bilirubin refears to any form of a yellowish pigment made in the liver when red blood cells are broken down. We can see pattern that levels of Total_Bilirubin are high for patients with liver diseases.  

```{r}
# Plotting distributions of Total_Bilirubin versus liver diseases
training %>% 
  ggplot(aes(as.numeric(row.names(training)),Total_Bilirubin, color=Disease)) +
  geom_boxplot() +
  labs(y="Total_Bilirubin", x = "Number of patients")+
  facet_wrap( ~ Disease) +
  ggtitle("Distribution of Total_Bilirubin w.r.t liver disease")

```

\subsection{Direct_Bilirubin}
Again, we can see that levels of Direct_Bilirubin are also high for patients with liver diseases.  

```{r}
# Plotting distributions of Total_Bilirubin versus liver diseases
training %>% 
  ggplot(aes(as.numeric(row.names(training)),Direct_Bilirubin, color=Disease)) +
  geom_boxplot() +
  labs(y="Direct_Bilirubin", x = "Number of patients")+
  facet_wrap( ~ Disease) +
  ggtitle("Distribution of Direct_Bilirubin w.r.t liver disease")

```
The correlations indicate that there is a weak correlation between liver disease and bilirubin. Though, the values are comparatively higher with liver diseases.
```{r}
subset_train <- training[c("Total_Bilirubin","Direct_Bilirubin")]
subset_train <- transform(subset_train, Disease= ifelse(training$Disease=="M", 1,0))
cor(subset_train) 
```
\subsection{Alkaline Phosphotase}
Alkaline phosphatase (ALP) is an enzyme in a person's blood that helps break down proteins. We observe that levels of Alkaline Phosphotase are comparatively high for patients with liver diseases.  

```{r}
# Plotting distributions of Alkaline Phosphotase versus liver diseases
training %>% 
  ggplot(aes(as.numeric(row.names(training)),Alkaline_Phosphotase, color=Disease)) +
  geom_boxplot() +
  labs(y="Alkaline Phosphotase", x = "Number of patients")+
  facet_wrap( ~ Disease) +
  ggtitle("Distribution of Alkaline Phosphotase w.r.t liver disease")
```
 
\subsection{Alamine_Aminotransferase}
Alanine aminotransferase (ALT) is an enzyme found primarily in the liver and kidney. ALT is increased with liver damage and is used to screen liver disease. We can see that levels of Alamine_Aminotransferase are high for patients with liver diseases.  

```{r}
# Plotting distributions of Alamine Aminotransferase versus liver diseases
training %>% 
  ggplot(aes(as.numeric(row.names(training)),Alamine_Aminotransferase, color=Disease)) +
  geom_boxplot() +
  labs(y="Alamine Aminotransferase", x = "Number of patients")+
  facet_wrap( ~ Disease) +
  ggtitle("Distribution of Alamine Aminotransferase w.r.t liver disease") 
```

\subsection{Aspartate_Aminotransferase}
Aspartate aminotransferase (AST) is an enzyme found in cells throughout the body but mostly in the heart and liver. In healthy individuals, levels of AST in the blood are low. When liver is damaged, they release AST into the blood thus raising the levels.We can see that levels of AST are comparatively high for very few patients with liver diseases.  

```{r}
# Plotting distributions of Aspartate_Aminotransferase versus liver diseases
training %>% 
  ggplot(aes(as.numeric(row.names(training)),Aspartate_Aminotransferase, color=Disease)) +
  geom_boxplot() +
  labs(y="Aspartate Aminotransferase", x = "Number of patients")+
  facet_wrap( ~ Disease) +
  ggtitle("Distribution of Aspartate Aminotransferase w.r.t liver disease") 
```
\subsection{Total Protiens}
The total protein test measures the total amount albumin and globulin in your body. It is used as part of your routine health checkup. The anaysis suggest that there is no correlation between liver disease and total protiens in our dataset. So, we will not use it for model training.

```{r}
# Plotting distributions of Total Protiens versus liver diseases
training %>% 
  ggplot(aes(as.numeric(row.names(training)),Total_Protiens, color=Disease)) +
  geom_boxplot() +
  labs(y="Total Protiens", x = "Number of patients")+
  facet_wrap( ~ Disease) +
  ggtitle("Distribution of Total Protiens w.r.t liver disease") 
```


\subsection{Albumin}
Albumin is a protein made by your liver. Albumin helps keep fluid in your bloodstream so it doesn't leak into other tissues. Low albumin levels can indicate a problem with your liver or kidneys. In our dataset, this variable has no strong correlation with the liver disease.

```{r}
# Plotting distributions of Albumin versus liver diseases
training %>% 
  ggplot(aes(as.numeric(row.names(training)),Albumin, color=Disease)) +
  geom_boxplot() +
  labs(y="Albumin", x = "Number of patients")+
  facet_wrap( ~ Disease) +
  ggtitle("Distribution of Albumin w.r.t liver disease") 
```
\subsection{Albumin_and_Globulin_Ratio}
There are two classes of proteins are found in the blood. They are important for body growth, development, and health. They form the structural part of most organs and make up enzymes and hormones that regulate body functions. We can see that these protiens have no correlation with the liver disease.

```{r}
# Plotting distributions of Albumin versus liver diseases
training %>% 
  ggplot(aes(as.numeric(row.names(training)),Albumin_and_Globulin_Ratio, color=Disease)) +
  geom_boxplot() +
  labs(y="Albumin and Globulin Ratio", x = "Number of patients")+
  facet_wrap( ~ Disease) +
  ggtitle("Distribution of Albumin and Globulin Ratio w.r.t liver disease") 
```
We can that Bilirubin enzymes are highly correlated with the liver disease. We are going to use these 5 variables to predict the liver disease.
```{r}
samples <- training 
samples <- transform(samples, Disease= ifelse(training$Disease=="M", 1,0))
#samples<-within(samples, rm(Age,Gender,Total_Protiens,Albumin,Albumin_and_Globulin_Ratio))
colnames(samples)<-c ("T_Bil","T_Bil","A_Phos","Al_Amin","Asp_Amino","Disease")
cor(samples)

```

\section{Methods}
\label{sec:methods}
In this section, we train different machine learning models using the training dataset.
\subsection{Logistic Regression}
We use logistic regression along with corss validation. The accuracy is around 0.71.
```{r}
ctrl <- trainControl(method = "repeatedcv", repeats = 3)

train_glm <- train(Disease~Total_Bilirubin+Direct_Bilirubin+Alkaline_Phosphotase+Alamine_Aminotransferase+Aspartate_Aminotransferase+Albumin, 
                   method = "glm",
                   data = training,
                   trControl=ctrl)
train_glm$results$Accuracy
```
\subsection{KNN}
We use KNN along with corss validation. The accuracy is around 0.71.
```{r}
ctrl <- trainControl(method = "repeatedcv", repeats = 5)

train_knn <- train(Disease~Total_Bilirubin+Direct_Bilirubin+Alkaline_Phosphotase+Alamine_Aminotransferase+Aspartate_Aminotransferase+Albumin, method = "knn", 
                   data = training,
                   tuneGrid = data.frame(k = seq(3, 51, 2)),
                   trControl = ctrl)
#ggplot(train_knn, highlight = TRUE)
print(max(train_knn$results$Accuracy))
```
\subsection{PLS}
```{r}
ctrl <- trainControl(method = "repeatedcv", repeats = 5)

train_pls <- train(Disease~Total_Bilirubin+Alkaline_Phosphotase+Aspartate_Aminotransferase+Total_Protiens, 
                     method = "pls",
                     data = training,
                     preProc = c("center", "scale"),
                      tuneLength = 15,
                      trControl = ctrl)
print(max(train_pls$results$Accuracy))

```
\subsection{LDA}
```{r}
ctrl <- trainControl(method = "repeatedcv", repeats = 3)

train_lda <- train(Disease~Total_Bilirubin+Direct_Bilirubin+Alkaline_Phosphotase+Alamine_Aminotransferase+Aspartate_Aminotransferase+Albumin, 
                     method = "lda",
                     data = training,
                      trControl = ctrl)
print(max(train_lda$results$Accuracy))

```

\subsection{QDA}
```{r}
ctrl <- trainControl(method = "repeatedcv", repeats = 3)

train_qda <- train(Disease~Total_Bilirubin+Direct_Bilirubin+Alkaline_Phosphotase+Alamine_Aminotransferase+Aspartate_Aminotransferase+Albumin, 
                     method = "qda",
                     data = training,
                      trControl = ctrl)
print(max(train_qda$results$Accuracy))

```
\subsection{Rpart}
```{r}
ctrl <- trainControl(method = "repeatedcv", repeats = 5)

train_rpart <- train(Disease~Total_Bilirubin+Direct_Bilirubin+Alkaline_Phosphotase+Alamine_Aminotransferase+Aspartate_Aminotransferase+Albumin, 
                     method = "rpart",
                     data = training,
                      trControl = ctrl,
                   tuneGrid = data.frame(cp = seq(0, 0.05, len = 25)))
#ggplot(train_rpart)
print(max(train_rpart$results$Accuracy))
```
\subsection{RF}
```{r}
library(caret)
ctrl <- trainControl(method = "repeatedcv", repeats = 5)

train_rpart <- train(Disease~Total_Bilirubin+Direct_Bilirubin+Alkaline_Phosphotase+Alamine_Aminotransferase+Aspartate_Aminotransferase+Albumin, 
                     method = "rf",
                     data = training,
                     trControl = ctrl,
                     tuneGrid = data.frame(mtry=seq(1,7)),
                     ntree=100)
#qplot(nodesize, acc)
print(max(train_rpart$results$Accuracy))
```

```{r}
ctrl <- trainControl(method = "repeatedcv", repeats = 5)

train_svm <- train(Disease~Total_Bilirubin+Direct_Bilirubin+Alkaline_Phosphotase+Alamine_Aminotransferase+Aspartate_Aminotransferase+Albumin, 
                     data = training,
                     method = "svmLinear",
                   trControl = ctrl,)
print(train_svm$results$Accuracy)
```

```{r}
ctrl <- trainControl(method = "repeatedcv", repeats = 5)

train_svm_radial <- train(Disease~Total_Bilirubin+Direct_Bilirubin+Alkaline_Phosphotase+Alamine_Aminotransferase+Aspartate_Aminotransferase+Albumin, 
                     data = training,
                     method = "svmRadial",
                   trControl = ctrl,)
print(train_svm_radial$results$Accuracy)
```
```{r}
library(mlbench)
library(caretEnsemble)
control <- trainControl(method="repeatedcv", repeats=5, savePredictions=TRUE, classProbs=TRUE)
algorithmList <- c('lda', 'rpart', 'glm', 'knn', 'svmRadial')
set.seed(1)
models <- caretList(Disease~Total_Bilirubin+Direct_Bilirubin+Alkaline_Phosphotase+Alamine_Aminotransferase+Aspartate_Aminotransferase,
                    data=training, 
                    trControl=control, 
                    methodList=algorithmList)
results <- resamples(models)
summary(results)
dotplot(results)
```

```{r}
summary(results)
stackControl <- trainControl(method="repeatedcv", number=10, repeats=3, savePredictions=TRUE, classProbs=TRUE)
stack.glm <- caretStack(models, method="glm", metric="Accuracy", trControl=stackControl)
print(stack.glm)
```


\begin{thebibliography}{9}
\bibitem{cad} 
Ethan Du-Crowa, Lucy Warrenb, Susan M Astleya and Johan Hullemanc,"Is there a safety-net effect with Computer-Aided Detection (CAD)?", Medical Imaging 2019.
\bibitem{ld}
Eugene, R., Sorrell, Michael F.; Maddrey, Willis C., "Schiff's Diseases of the Liver", 10th Edition, Lippincott Williams \& Wilkins by Schiff.

\bibitem{bendi}
Bendi,  Venkata . R, M. S. Prasad Babu, and N. B. Venkateswarlu, "Critical Comparative Study of Liver Patients from USA and INDIA: An Exploratory Analysis", International Journal of Computer Science Issues, May 2012.


\end{thebibliography}


